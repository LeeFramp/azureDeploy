{
  "$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {
    "nestedTemplateUri" : {
      "type": "string",
      "minLength": 14,
      "metadata": {
        "description" : "The URI hosting nested templates, for linked deployments"
      }
    },
    "adminUsername": {
      "type": "string",
      "metadata": {
        "description": "Admin username"
      }
    },
    "adminPassword": {
      "type": "securestring",
      "metadata": {
        "description": "Admin password"
      }
    },
    "resourcePrefix": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "Prefix to use for resource names"
      }
    },
    "imagePublisher": {
      "type": "string",
      "defaultValue": "MicrosoftWindowsServer",
      "metadata": {
        "description": "Image Publisher"
      }
    },
    "imageOffer": {
      "type": "string",
      "defaultValue": "WindowsServer",
      "metadata": {
        "description": "Image Offer"
      }
    },
    "imageSKU": {
      "type": "string",
      "defaultValue": "2012-R2-Datacenter",
      "allowedValues": [
        "2012-R2-Datacenter"
      ],
      "metadata": {
        "description": "Image SKU"
      }
    },
    "vmSize": {
      "type": "string",
      "minLength": 1,
      "defaultValue": "Standard_A1",
      "metadata": {
        "description": "Size of the virtual machine, must be available in the virtual machine's location"
      }
    },
    "instanceCount": {
      "type": "int",
      "defaultValue": 2,
      "metadata": {
        "description": "Number of Virtual Machines to create"
      }
    },
    "storageAccountType": {
      "type": "string",
      "defaultValue": "Standard_LRS",
      "metadata": {
        "description": "Storage Account Type for Virtual Machines"
      }
    },
    "vNetResourceGroup": {
      "type": "string",
      "metadata": {
        "description": "Name of Resource Group containing Virtual Network"
      }
    },
    "vnetName": {
      "type": "string",
      "defaultValue": "myVNET",
      "metadata": {
        "description": "vNet name"
      }
    },
    "subnetName": {
      "type": "string",
      "defaultValue": "SubnetDefault",
      "metadata": {
        "description": "The name of the Subnet where Virtual Machines will be created"
      }
    }
  },
  "variables": {
    "storageAccountName": "[concat(toLower(replace(uniqueString(resourceGroup().id),'-','')))]",
    "availabilitySetName": "[parameters('resourcePrefix')]",
    "vhdStoragePath" : "[concat('http://',variables('storageAccountName'),'.blob.core.windows.net/vhds/')]",
    "vNetID" : "[resourceId(parameters('vNetResourceGroup'), 'Microsoft.Network/virtualNetworks', parameters('vNetName'))]",
    "subnetRef": "[concat(variables('vnetID'),'/subnets/',parameters('subnetName'))]",
    "nicName" : "[parameters('resourcePrefix')]"
  },
  "resources": [
    {
        "type": "Microsoft.Resources/deployments",
        "name": "[concat(variables('storageAccountName'),'-StorageAccount')]",
        "apiVersion": "2015-01-01",
        "properties": {
            "mode": "Incremental",
            "templateLink": {
                "uri": "[concat(parameters('nestedTemplateUri'), 'storageAccount.json')]",
                "contentVersion": "1.0.0.0"            
            },
            "parameters": {
                "storageAccountType": {"value":"[parameters('storageAccountType')]"},
                "storageAccountName": {"value":"[variables('storageAccountName')]"},
                "location": {"value":"[resourceGroup().location]"}
            }
        }
    },
    {
        "type": "Microsoft.Resources/deployments",
        "name": "[concat(variables('availabilitySetName'),'-AvailabilitySet')]",
        "apiVersion": "2015-01-01",
        "properties": {
            "mode": "Incremental",
            "templateLink": {
                "uri": "[concat(parameters('nestedTemplateUri'), 'availabilitySet.json')]",
                "contentVersion": "1.0.0.0"
            },
            "parameters": {
                "availabilitySetName": {"value": "[variables('availabilitySetName')]"},
                "location": {"value": "[resourceGroup().location]"}
            }
        }
    },
    {
        "type": "Microsoft.Resources/deployments",
        "name": "[concat(parameters('resourcePrefix'),'-staticNetworkInterfaces')]",
        "apiVersion": "2015-01-01",
        "dependsOn": [],
        "properties": {
            "mode": "Incremental",
            "templateLink": {
                "uri": "[concat(parameters('nestedTemplateUri'), 'nic-staticip.deploy.json')]",
                "contentVersion": "1.0.0.0"
            },
            "parameters": {
            "nestedTemplateUri" : {"value":"[parameters('nestedTemplateUri')]"},
            "subnetRef": {"value": "[variables('subnetRef')]"},
            "nicName": {"value": "[concat(variables('nicName'))]"},
            "instanceCount" : {"value": "[parameters('instanceCount')]"},
            "location": {"value": "[resourceGroup().location]"}
            }
        }
    },
    {
        "apiVersion": "2015-06-15",
        "type": "Microsoft.Compute/virtualMachines",
        "name": "[concat(parameters('resourcePrefix'), '-', padleft(copyindex(1), 2, '0'),'-VM')]",
        "copy": {
            "name": "virtualMachineLoop",
            "count": "[parameters('instanceCount')]"
        },
        "location": "[resourceGroup().location]",
        "dependsOn": [
            "[concat('Microsoft.Storage/storageAccounts/', variables('storageAccountName'))]",
            "[concat('Microsoft.Compute/availabilitySets/', parameters('resourcePrefix'))]",
            "[concat('Microsoft.Resources/deployments/',parameters('resourcePrefix'), '-networkInterfaces')]" 
        ],
        "properties": {
            "availabilitySet": {
            "id": "[resourceId('Microsoft.Compute/availabilitySets',parameters('resourcePrefix'))]"
            },
            "hardwareProfile": {
            "vmSize": "[parameters('vmSize')]"
            },
            "osProfile": {
            "computerName": "[concat(parameters('resourcePrefix'), '-', padleft(copyindex(1), 2, '0'))]",
            "adminUsername": "[parameters('adminUsername')]",
            "adminPassword": "[parameters('adminPassword')]"
            },
            "storageProfile": {
            "imageReference": {
                "publisher": "[parameters('imagePublisher')]",
                "offer": "[parameters('imageOffer')]",
                "sku": "[parameters('imageSKU')]",
                "version": "latest"
            },
            "osDisk": {
                "name": "osdisk",
                "vhd": {
                "uri": "[concat(variables('vhdStoragePath'),parameters('resourcePrefix'), '-', padleft(copyindex(1), 2, '0'),'-osdisk.vhd')]"
                },
                "caching": "ReadWrite",
                "createOption": "FromImage"
            },
            "dataDisks": []
            },
            "networkProfile": {
            "networkInterfaces": [
                {
                "id": "[resourceId('Microsoft.Network/networkInterfaces',concat(parameters('resourcePrefix'), '-', padleft(copyindex(1), 2, '0')))]"
                }
            ]
            },
            "diagnosticsProfile": {
            "bootDiagnostics": {
                "enabled": "true",
                "storageUri": "[concat('http://',variables('storageAccountName'),'.blob.core.windows.net')]"
            }
            }
        }
    }
  ]
}